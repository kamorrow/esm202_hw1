---
title: ESM 202 Assignment 1
author: Keene Morrow
date: 1/21/2020
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(janitor)
library(here)
library(kableExtra)
```

```{r, include = FALSE}
# Set up
ch_wshd_A <- 165740 # km^2
ch_wshd_A_m <- ch_wshd_A * 1000 ^ 2 # m^2
ch_tot_inflow <- 1833 #m/s^2
ch_tot_V <- 68 # km^3
ch_tot_V_m <- ch_tot_V * 10 ^ 9 # m^3

# Long term nutrient inputs to rivers
sus_char <- c("rural", "forested", "agricultural") # Susquehanna
pot_char <- c("urban", "agricultural") # Potomac
cho_char <- "agricultural" # Choptank

# River Info
rivers <- read_csv(here("data", "river_info.csv")) %>%
  janitor::clean_names()

# Water Quality Parameters
wq_param <- read_csv(here("data", "wq_param.csv"))
```
```{r, echo = FALSE}
rivers_display <- rivers %>%
  rename("USGS Site ID" = usgs_site_id,
         River = river,
         "River Abbreviation" = river_abb,
         Location = location,
         State = state,
         "Mean Flow (m3/s)" = mean_flow_m3_s)

kable(rivers_display)%>% 
  kable_styling(bootstrap_options = "striped", 
                full_width = F,
                position = "center"
                ) %>% 
  add_header_above(c("Chesapeake Bay Contributing Rivers" = 6))
```

### 1. Mass Balance

#### a) Calculate the percent contribution of each river to the total water flux into the Chesapeake Bay. 
```{r}
river_contrib <- rivers %>%
  mutate(pct_contrib = round((mean_flow_m3_s / ch_tot_inflow)*100, digits = 2)) %>%
  select(river, pct_contrib) %>%
  rename("Percent Contribution" = pct_contrib,
         River = river)
```


```{r, echo = FALSE}
kable(river_contrib)%>% 
  kable_styling(bootstrap_options = "striped", 
                full_width = F,
                position = "center"
                ) %>% 
  add_header_above(c("Table 1.\nPercent Contribution to Chesapeake Bay Flux by River" = 2))
```

#### b) Considering the rivers as the total inflow, what is the approximate turnover time for water in the Chesapeake Bay? Assume that tidal exchange has no net effect on the total volume of the Chesapeake Bay. 

```{r}
# Chesapeake Bay turnover in seconds
ch_turnover <- ch_tot_V_m / ch_tot_inflow

# Chesapeake Bay turnover in days
ch_turn_days <- ch_turnover / (60 ^ 2 * 24)

# Chesapeake Bay turnover in years
ch_turn_yr <- ch_turn_days / 365.25
```

The turnover time of the Chesapeake Bay is `r round(ch_turn_days, digits = 2)` days or `r round(ch_turn_yr, digits = 2)` years.

#### c) What is the mean concentration (in μg/L) of total nitrogen (TN) and total phosphorus (TP) entering the Chesapeake Bay from each river (only SUS, POT and CHO) in the 1st quarter of 2010?

```{r}
# Total Phosphorus kg/day, 2010, Quarter 1, in order, SUS, POT, CHO
tp_2010_q1_kg_d <- c(1.6 * 7200, 1.4 * 4700, 1.5 * 40)

# Total Nitrogen kg/day, 2010, Quarter 1, in order, SUS, POT, CHO
tn_2010_q1_kg_d <- c(1.5 * 160000, 1.5 * 64000, 1.75 * 600)

rivers_ug_L <- rivers %>%
  # only the rivers of interest
  filter(river_abb %in% c("SUS", "POT", "CHO")) %>%
  # add TP and TN data from above
  cbind(tp_2010_q1_kg_d,
        tn_2010_q1_kg_d) %>% 
  # Conversions
  mutate(mean_flow_L_s = mean_flow_m3_s * 1000,
         tp_2010_q1_ug_d = tp_2010_q1_kg_d * 10 ^ 9,
         tn_2010_q1_ug_d = tn_2010_q1_kg_d * 10 ^ 9) %>%
  mutate(tp_2010_q1_ug_s = tp_2010_q1_ug_d / 86400,
         tn_2010_q1_ug_s = tn_2010_q1_ug_d / 86400) %>%
  # Calculate Mean Concentration of TP and TN in each river
  mutate(mean_conc_tp_2010_q1_ug_L = tp_2010_q1_ug_s / mean_flow_L_s,
         mean_conc_tn_2010_q1_ug_L = tn_2010_q1_ug_s / mean_flow_L_s)

# Prep df for table
mean_conc_2010 <- rivers_ug_L %>%
  select(river, mean_conc_tp_2010_q1_ug_L, mean_conc_tn_2010_q1_ug_L) %>%
  mutate(mean_conc_tp_2010_q1_ug_L = round(mean_conc_tp_2010_q1_ug_L, digits = 2),
         mean_conc_tn_2010_q1_ug_L= round(mean_conc_tn_2010_q1_ug_L, digits = 2)) %>% 
  rename("Total Phosphorus" = mean_conc_tp_2010_q1_ug_L,
         "Total Nitrogen" = mean_conc_tn_2010_q1_ug_L,
         River = river)
```


```{r, echo = FALSE}
kable(mean_conc_2010)%>% 
  kable_styling(bootstrap_options = "striped", 
                full_width = F,
                position = "center"
                ) %>% 
  add_header_above(c("Table 2.\nMean Concentrations (μg/L) entering the Chesapeake Bay by River\nQuarter 1, 2010" = 3))

```

#### d) Express the concentrations of TN and TP also in terms of moles/L of N and P. 

```{r}
N_atomic <- 14.00 # g / mol
P_atomic <- 30.97 # g / mol

N_ug_mol <- N_atomic * 10 ^ 6 # ug / mol
P_ug_mol <- P_atomic * 10 ^ 6 # ug / mol

mean_conc_2010_mol_L <- rivers_ug_L %>%
  # Convert ug/L to mol/L
  mutate(mean_conc_tp_2010_q1_mol_L = mean_conc_tp_2010_q1_ug_L / P_ug_mol,
         mean_conc_tn_2010_q1_mol_L = mean_conc_tn_2010_q1_ug_L / N_ug_mol) %>%
  # Prep for table
  select(river, mean_conc_tp_2010_q1_mol_L, mean_conc_tn_2010_q1_mol_L) %>%
  mutate(mean_conc_tp_2010_q1_mol_L = formatC(mean_conc_tp_2010_q1_mol_L, format = "e", digits = 2),
         mean_conc_tn_2010_q1_mol_L= formatC(mean_conc_tn_2010_q1_mol_L, format= "e", digits = 2)) %>%
  rename("Total Phosphorus" = mean_conc_tp_2010_q1_mol_L,
         "Total Nitrogen" = mean_conc_tn_2010_q1_mol_L,
         River = river)
```


```{r, echo = FALSE}
kable(mean_conc_2010_mol_L)%>% 
  kable_styling(bootstrap_options = "striped", 
                full_width = F,
                position = "center"
                ) %>% 
  add_header_above(c("Table 3.\nMean Concentrations (mol/L) entering the Chesapeake Bay by River\nQuarter 1, 2010" = 3))

```


#### e) How many kg of TN and TP are being discharged into the Chesapeake Bay from each river (only SUS, POT and CHO) in the 1st quarter of 2010? 

```{r}
t_q1_d <- 31 + # January
  28 + # February
  31 # March

rivers_kg_q1 <- rivers %>%
  # only the rivers of interest
  filter(river_abb %in% c("SUS", "POT", "CHO")) %>%
  # add TP and TN data from above
  cbind(tp_2010_q1_kg_d,
        tn_2010_q1_kg_d) %>%
  mutate(tp_2010_q1_kg_qtr = tp_2010_q1_kg_d * t_q1_d,
         tn_2010_q1_kg_qtr = tn_2010_q1_kg_d * t_q1_d) %>%
  select(river, tp_2010_q1_kg_qtr, tn_2010_q1_kg_qtr) %>%
  rename("Total Phosphorus" = tp_2010_q1_kg_qtr,
         "Total Nitrogen" = tn_2010_q1_kg_qtr,
         River = river)
```

```{r echo = FALSE}
kable(rivers_kg_q1)%>% 
  kable_styling(bootstrap_options = "striped", 
                full_width = F,
                position = "center"
                ) %>% 
  add_header_above(c("Table 4.\nTotal Contribution (kg) entering the Chesapeake Bay by River \nQuarter 1, 2010" = 3))
```

#### f) Approximately what fraction of the total mass of N and P is coming in as dissolved N (DN) or dissolved P (DP) in the 1st quarter of 2010?
```{r}
# Dissolved Phosphorus kg/day, 2010, Quarter 1, in order, SUS, POT, CHO
dp_2010_q1_kg_d <- c(1.2 * 1600, 0.7 * 1100, 1.3 * 14)

# Dissolved Nitrogen kg/day, 2010, Quarter 1, in order, SUS, POT, CHO
dn_2010_q1_kg_d <- c(1.4 * 140000, 1.5 * 48000, 1.7 * 540)


rivers_dis_tot <- rivers %>%
  # only the rivers of interest
  filter(river_abb %in% c("SUS", "POT", "CHO")) %>%
  # add TP, TN, DP, DN data from above
  cbind(dp_2010_q1_kg_d,
        tp_2010_q1_kg_d) %>%
  mutate(dis_tot_P_2010_q1_kg_d = round((dp_2010_q1_kg_d /tp_2010_q1_kg_d), digits = 2)) %>% 
  cbind(dn_2010_q1_kg_d,
        tn_2010_q1_kg_d) %>%
  mutate(dis_tot_N_2010_q1_kg_d = round((dn_2010_q1_kg_d /tn_2010_q1_kg_d), digits = 2)) %>%
  select(river, dis_tot_P_2010_q1_kg_d, dis_tot_N_2010_q1_kg_d) %>%
  rename(River = river,
         "Nitrogen" = dis_tot_N_2010_q1_kg_d,
         "Phosphorus" = dis_tot_P_2010_q1_kg_d)
```

```{r echo = FALSE}
kable(rivers_dis_tot)%>% 
  kable_styling(bootstrap_options = "striped", 
                full_width = F,
                position = "center"
                ) %>% 
  add_header_above(c("Table 5.\n Contribution of Dissolved Mass to Total Mass entering the Chesapeake Bay by River \nQuarter 1, 2010" = 3))
```
#### g) Calculate the total mass/day of suspended sediments being added to the Chesapeake Bay during the 1st quarter of 2010 by each river.
```{r}
susp_solids <- c(2.2 * 4300000, 1.75 * 4100000, 1.8 * 7100)

rivers_solids <- rivers %>%
  # only the rivers of interest
  filter(river_abb %in% c("SUS", "POT", "CHO")) %>%
  # add TP, TN, DP, DN data from above
  cbind(susp_solids) %>%
  select(river, susp_solids) %>%
  rename(River = river,
         "Suspended Solids" = susp_solids)
```

```{r echo = FALSE}
kable(rivers_solids)%>% 
  kable_styling(bootstrap_options = "striped", 
                full_width = F,
                position = "center"
                ) %>% 
  add_header_above(c("Table 6.\n Contribution of Suspended Solids (kg/day) to the Chesapeake Bay by River \nQuarter 1, 2010" = 2))
```

### 2. Water quality (consider only the SUS, POT and CHO or as indicated)

#### a) Given the molar ratio of 100:16:1 [C:N:P], which nutrient would be limiting in each river during the 1st quarter of 2010?
```{r}
wq_limitation <- rivers_ug_L %>%
  # Convert ug/L to mol/L
  mutate(mean_conc_tp_2010_q1_mol_L = mean_conc_tp_2010_q1_ug_L / P_ug_mol,
         mean_conc_tn_2010_q1_mol_L = mean_conc_tn_2010_q1_ug_L / N_ug_mol) %>%
  mutate(ratio_N_P = mean_conc_tn_2010_q1_mol_L / mean_conc_tp_2010_q1_mol_L) %>%
  mutate(limited = ifelse(ratio_N_P < 10, "Nitrogen", ifelse(ratio_N_P >30, "Phosphorus", "Not Limited"))) %>%
  select(river, limited) %>%
  rename(River = river,
         "Limited by" = limited)
```

```{r echo = FALSE}
kable(wq_limitation)%>% 
  kable_styling(bootstrap_options = "striped", 
                full_width = F,
                position = "center"
                ) %>% 
  add_header_above(c("Table 7.\n Limiting Nutrients\nQuarter 1, 2010" = 2))
```

#### b) Given the molar ratio of 100:16:1 [C:N:P] and given the molar ratio of C:H:O for biomass as 1:2:1, is the dissolved nitrogen during the 1st quarter of 2012 likely to deplete oxygen in the Choptank River? Assume the dissolved oxygen is 4.5 mg/L in the receiving water at the point of discharge.

```{r}
DO_mg_L <- 4.5 # mg/L
O_atomic <- 16 # g / mol

DO_mol_L <- (DO_mg_L / 1000) / 16

dn_cho_mol_L <- (rivers_ug_L$mean_conc_tn_2010_q1_ug_L[3] * rivers_dis_tot$Nitrogen[3]) / N_ug_mol

dn_cho_mg <- rivers_ug_L$mean_conc_tn_2010_q1_ug_L[3] / 1000

dn_cho_mol_L / DO_mol_L

ratio_df_el <- c("C", "N", "P", "H", "O")
ratio_df_num <- c(100, 16, 1, 200, 100)
ratio_cho_DO <- c("", "", "", "", DO_mol_L)
ratio_cho_DN <- c("", dn_cho_mol_L, "", "", "")

ratio <- as.data.frame(ratio_df_el) %>%
  cbind(ratio_df_num) %>%
  mutate(DO_ratio = ratio_df_num / 100,
         DN_ratio = ratio_df_num / 16) %>%
  mutate(DO_level = DO_ratio * DO_mol_L,
         DN_level = DN_ratio * dn_cho_mol_L) %>%
  rename(element = ratio_df_el,
         std_ratio = ratio_df_num)
```

The maximum dissolved nitrogen level that would not deplete dissolved oxygen at `r DO_mol_L` mol/L is `r ratio$DN_lelve[2]` mol/L.  The actual level of dissolved nitrogen in the Choptank River in the first quarter of 2012 was `r dn_cho_mol_L` mol/L.  Thus, it is expected that dissolved oxygen would be completely depleted.

#### c) Free Space

#### d) Given the concentrations of TN and TP, how would you classify the eutrophication potential of each of the three rivers in terms in the Chesapeake Bay in 1980 and 2010? 
```{r}
# Total Phosphorus kg/day, 1980, Quarter 1, in order, SUS, POT, CHO
tp_1980_q1_kg_d <- c(2.0 * 7200, 2.0 * 4700, 1.3 * 40)

# Total Nitrogen kg/day, 1980, Quarter 1, in order, SUS, POT, CHO
tn_1980_q1_kg_d <- c(1.6 * 160000, 1.75 * 64000, 1.5 * 600)


eutrophication <- rivers %>%
  # only the rivers of interest
  filter(river_abb %in% c("SUS", "POT", "CHO")) %>%
  # add TP and TN data from above
  cbind(tp_1980_q1_kg_d,
        tn_1980_q1_kg_d,
        tp_2010_q1_kg_d,
        tn_2010_q1_kg_d) %>% 
  # Conversions
  mutate(mean_flow_L_s = mean_flow_m3_s * 1000,
         tp_1980_q1_ug_d = tp_1980_q1_kg_d * 10 ^ 9,
         tn_1980_q1_ug_d = tn_1980_q1_kg_d * 10 ^ 9,
         tp_2010_q1_ug_d = tp_2010_q1_kg_d * 10 ^ 9,
         tn_2010_q1_ug_d = tn_2010_q1_kg_d * 10 ^ 9) %>%
  mutate(tp_1980_q1_ug_s = tp_1980_q1_ug_d / 86400,
         tn_1980_q1_ug_s = tn_1980_q1_ug_d / 86400,
         tp_2010_q1_ug_s = tp_2010_q1_ug_d / 86400,
         tn_2010_q1_ug_s = tn_2010_q1_ug_d / 86400) %>%
  # Calculate Mean Concentration of TP and TN in each river
  mutate(mean_conc_tp_1980_q1_ug_L = tp_1980_q1_ug_s / mean_flow_L_s,
         mean_conc_tn_1980_q1_ug_L = tn_1980_q1_ug_s / mean_flow_L_s,
         mean_conc_tp_2010_q1_ug_L = tp_2010_q1_ug_s / mean_flow_L_s,
         mean_conc_tn_2010_q1_ug_L = tn_2010_q1_ug_s / mean_flow_L_s) %>%
  mutate(ratio_N_P_1980 = mean_conc_tn_1980_q1_ug_L / mean_conc_tp_1980_q1_ug_L,
         ratio_N_P_2010 = mean_conc_tn_2010_q1_ug_L / mean_conc_tp_2010_q1_ug_L,
         eu_potential_1980 = ifelse(mean_conc_tp_1980_q1_ug_L > 15, ifelse(mean_conc_tp_1980_q1_ug_L > 100, "Potentially Hypereutrophic", "Likely Eutrophic"), "Unlikely Eutrophic" ),
         eu_potential_2010 = ifelse(mean_conc_tp_2010_q1_ug_L > 15, ifelse(mean_conc_tp_2010_q1_ug_L > 100, "Potentially Hypereutrophic", "Likely Eutrophic"), "Unlikely Eutrophic" ))
```

In both 1980 and 2010 all three rivers had sufficient total nitrogen and total phosphorus levels to have a high eutrophication potential, to the extent that they were all potentially hypertrophic in both years.


#### e) What other water quality parameter(s) are important to determine the health of aquatic organisms (e.g. fish) in these three tributaries? Briefly discuss at least 5.


#### f) Given the loadings of N and P, qualitatively discuss the likely redox conditions in the Chesapeake Bay sediments. What are the implications (briefly)? 

#### g) For the data sets provided (1980 to 2010), discuss the relative improvement/degradation of each river in the Chesapeake Bay. 
